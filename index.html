<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="public/js/d3.v3.min.js"></script>
    <script src="public/js/underscore-min.js"></script>
    <script src="public/js/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
    <style>
    #chart2 {
        overflow-y: scroll;
        width: 400px;
    }
    
    #chart2 svg {
        height: 100vh;
    }
    
    .izdvojen {
        transform: scale(1.10);
    }
    
    .vracen {
        transform: scale(1);
    }
    
    .bar.positive {
        fill: steelblue;
    }
    
    .bar.negative {
        fill: brown;
    }
    </style>
</head>

<body>
    <form>
        <select name="postupak" id="">
            <option value="otvoreni">Otvoreni</option>
            <option value="restriktivni">Restriktivni</option>
            <option value="sa_objavljivanjem">Sa objavljivanjem</option>
            <option value="bez_objavljivanja">Bez objavljivanja</option>
            <option value="kvalifikacioni">Kvalifikacioni</option>
        </select>
        <select name="predmet" id="">
            <option value="dobra">Dobra</option>
            <option value="usluge">Usluge</option>
            <option value="radovi">Radovi</option>
        </select>
        <select name="ponuda" id="">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
        </select>
        <input type="number" name="cena">
        <button type="button">Trazi</button>
    </form>
    <div class="tip"></div>
    <div id="sequence"></div>
    <div id="wrap" class="row">
        <div id="chart" class="col-md-8"></div>
        <div id="chart2" class="col-md-4"></div>
    </div>
    <script>
    //http://bl.ocks.org/mbostock/4063423



    // Dimensions of sunburst.
    var width = 750;
    var height = 600;
    var radius = Math.min(width, height) / 2;

    // Breadcrumb dimensions: width, height, spacing, width of tip/tail.
    var b = {
        w: 220,
        h: 30,
        s: 3,
        t: 10
    };

    // Mapping of step names to colors.
   
    var colors = 
    {
	  "radovi":{
	    "osnovna": "#1b9e77",
	    "izvedene": {
	      "restriktivni": "#093427",
	      "otvoreni": "#157A5C",
	      "sa_objavljivanjem": "#23D19D",
	      "bez_objavljivanja": "#62E4BD",
	      "kvalifikacioni": "#CBF6E9"
	    }
	  },
	  "dobra": {	    
	    "osnovna": "#d95f02",
	    "izvedene": {
	      "restriktivni": "#3D1B01",
	      "otvoreni": "#A24702",
	      "sa_objavljivanjem": "#FD8021",
	      "bez_objavljivanja": "#FD9749",
	      "kvalifikacioni": "#FED1AE"
	    }
	  },
	  "usluge":{	    
	    "osnovna": "#7570b3",
	    "izvedene": {
	      "restriktivni": "#1E1C35",
	      "otvoreni": "#433F78",
	      "sa_objavljivanjem": "#5A54A0",
	      "bez_objavljivanja": "#A4A1CE",
	      "kvalifikacioni": "#D8D7EA"
	    }
	  }
	}


    var HTMLabsoluteTip = d3.select("div.tip");

    var mera = radius * 0.5;

    // Total size of all segments; we set this later, after loading the data.
    var totalSize = 0;
    var pomeraj = -mera / 2;

    var vis = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("svg:g")
        .attr("id", "container")
        .attr("transform", "translate(" + width / 3 + "," + height / 2 + ")")
        .append("g")
        .attr("id", "rotiraj");



    var label = vis.append("g");
    label.append('foreignObject')
        .attr('width', mera)
        .attr('height', mera)
        .attr("transform", "translate(" + pomeraj + "," + pomeraj + ")")
	.append("xhtml:div")    	
        .attr('id', "labelCenter")
        .append("xhtml:p");
        
        //.attr("dy", ".35em")
        /*.attr("x", -55)
        .attr("y", -5);*/
    //.text(function(d) { return "lalalla"; });		


    //change dinaicly size of circle
    var partition = d3.layout.partition()
        .sort(null)
        .size([2 * Math.PI, radius * radius * 0.5])
        .value(function(d) {
            return 1;
        });

    var arc = d3.svg.arc()
        .startAngle(function(d) {
            return d.x;
        })
        .endAngle(function(d) {
            return d.x + d.dx;
        })
        .innerRadius(function(d) {
            return Math.sqrt(d.y);
        })
        .outerRadius(function(d) {
            return Math.sqrt(d.y + d.dy);
        });


    d3.csv('rawData/uzorak.csv', function(err, data) {


        var json = transformData(data);

        createVisualization(json);
    })


    function transformData(all) {
        var tempObje = {
            "name": "Bezbednost",
            "children": []
        };

        var dobra = all.filter(function(la) {
            return la.predmet == "Dobra";
        })
        var usluge = all.filter(function(la) {
            return la.predmet == "Usluge";
        })
        var radovi = all.filter(function(la) {
            return la.predmet == "Radovi";
        })

        var poljaZaDif = ["restriktivni", "otvoreni", "sa objavljivanjem", "bez objavljivanja", "kvalifikacioni"];

        dobra = filter2nivo("Dobra",dobra, poljaZaDif, colors.dobra.izvedene);
        usluge = filter2nivo("Usluge",usluge, poljaZaDif, colors.usluge.izvedene);
        radovi = filter2nivo("Radovi",radovi, poljaZaDif, colors.radovi.izvedene);


        tempObje.children.push({
            "name": "Dobra",
            "children": dobra,
            "color":colors.dobra.osnovna
        });
        tempObje.children.push({
            "name": "Usluge",
            "children": usluge,
            "color":colors.usluge.osnovna
        });
        tempObje.children.push({
            "name": "Radovi",
            "children": radovi,
            "color":colors.radovi.osnovna
        });

        return tempObje;
    }


    function filter2nivo(kat, niz, poljaZaDif, boje) {

        var param = 'opis_predmeta';

        var katego = ["restriktivni", "otvoreni", "sa objavljivanjem", "bez objavljivanja", "kvalifikacioni"];

        poljaZaDif.forEach(function(to) {
            var tempOb = {
                "name": kat,
                "children": []
            };

            var tempArr = niz.filter(function(nesto) {
                //nazivi ove kategorije su mnogo dugacki, pa samo uporedjujem deo
                return nesto.postupak.toLowerCase().indexOf(to) != -1;
            }).map(function(te) {
            	var boja1 = "";
            	katego.forEach(function(la){
            		if(te.postupak.toLowerCase().indexOf(la)!=-1)
            		boja1 = la.replace(" ","_"); 
            	})
                

                te.name = te.postupak ;//+ " <br> <br> " +  te[param]/*.substr(0, 15)*/ ;
                
                te.color = boje[boja1];
                return te;
            })

            tempOb.children = tempArr;
        })

        return niz;
    }



    /*======================================
    =            filterPretraga            =
    ======================================*/

    function filterPretraga(nizArgumenata) {


        var tempEl = d3.selectAll("path").filter(function(la, po) {
            var uslov = true;
            if (la.children != undefined) return false;
            for (var i = 0, len = nizArgumenata.length; i < len; i++) {

                if (nizArgumenata[i].name == "postupak")
                    uslov &= la["postupak"].toLowerCase().indexOf(nizArgumenata[i].value.replace("_", " ")) != -1;
                else if (nizArgumenata[i].name == "predmet")
                    uslov &= la["predmet"].toLowerCase().indexOf(nizArgumenata[i].value) != -1;
                else if (nizArgumenata[i].name == "ponuda")
                    uslov &= +la["broj_ponuda"] == +nizArgumenata[i].value;
                else if (nizArgumenata[i].name == "cena_pdv")
                    uslov &= +la["cena_pdv"] >= +nizArgumenata[i].value;

                //postupak predmet, ponuda , cena 
            }

            return uslov;
        })

        return tempEl
    }

    d3.select("button").on("click", function() {
        var parametri = $("form").serializeArray();
        var res = filterPretraga(parametri)
        res.style("fill", "red");


        secondGraph(res.data())
            //napraviti poseban graf ovde
    })



    // da se prekine animacija

    //neki button ce biti	
    /*  d3.select("input").on("change", change);

		  var sortTimeout = setTimeout(function() {
		    d3.select("input").property("checked", true).each(change);
		  }, 2000);*/




    function secondGraph(data) {
        var width = 350;
        var height = 600;

        var svgDrugi = d3.select("#chart2").append("svg")

        .append("g")
            .attr('id', "resList")
            .attr("transform", "translate(" + 0 + "," + 0 + ")");


        var x = d3.scale.linear()
            .range([0, 250]);

        var y = d3.scale.ordinal()
            .rangeRoundBands([0, height],.25);

        //definisati max sirinu
        //i pomeraj
        x.domain([0, 250])
            //x.domain(d3.extent(data, function(d) { return d.cena_pdv; })).nice();
        y.domain(
        	data.map(function(d) {
            	return +d.idNum ;
        	})
    	)


        svgDrugi.selectAll(".bar")
            .data(data)
            .enter().append("rect")
            .attr("class", function(d) {
                return "bar negative";
            })
            .attr("x", function(d) {
                return x(Math.floor(Math.random() * 10));
            })
            .attr("y", function(d) {
                //return +d.idNum * 15;	
                return y(d.idNum) + 5;
            })
            .attr("width", 150)
            .attr("height", 12)
            .on("mouseover", function(l, e) {
                console.log(l)
            })
            .on("click", change);

        function change(nes) {
            //clearTimeout(sortTimeout);
            nes = false
                // Copy-on-write since tweens are evaluated after a delay.
            var y0 = y.domain(
                    data.sort(
                        nes ? function(a, b) {
                            return b.cena_pdv - a.cena_pdv;
                        } : function(a, b) {
                            return d3.ascending(a.broj_ponuda, b.broj_ponuda);
                        })

                    .map(function(d) {
                        return +d.idNum;
                    }))
                .copy();

            svgDrugi.selectAll(".bar")
                .sort(function(a, b) {
                    return y0(a.idNum) - y0(b.idNum);
                });

            var transition = svgDrugi.transition().duration(750),
                delay = function(d, i) {
                    return i * 50;
                };

            transition.selectAll(".bar")
                .delay(delay)
                .attr("y", function(d) {
                    return y0(d.idNum) ;
                });


        }

    }

    /*=====  End of filterPretraga  ======*/


    function createVisualization(json) {


        // Basic setup of page elements.
        initializeBreadcrumbTrail();

        // Bounding circle underneath the sunburst, to make it easier to detect
        // when the mouse leaves the parent g.
        vis.append("svg:circle")
            .attr("r", radius)
            .style("opacity", 0);

        // For efficiency, filter nodes to keep only those large enough to see.
        var nodes = partition.nodes(json)
            .filter(function(d) {
                return (d.dx > 0.005); // 0.005 radians = 0.29 degrees
            });

        var path = vis/*.data([json])*/.selectAll("path")
            .data(nodes)
            .enter().append("svg:path")
            .attr("display", function(d) {
                return d.depth ? null : "none";
            })
            .attr("d", arc)
            .attr("fill-rule", "evenodd")
            .style("stroke", "#fff")
            .style("fill", function(d) {
            	return  d.color;
            })
            .style("opacity", 1)
            .on("mouseover", mouseover)
            .on("mouseleave", mouseleaveCell)
            //.on("click", mrdniGa)
            .each(stash);

        // Add the mouseleave handler to the bounding circle.
        d3.select("#container").on("mouseleave", mouseleave);

        // Get total size of the tree = value of root node from partition.
        totalSize = path.node().__data__.value;





        d3.selectAll("input").on("change", function() {
            /*var value = this.value === "count" ? function() {
                return 1;
            } : function(d) {
                return d.size;
            };

            path
                .data(partition.value(value).nodes)
                .transition()
                .duration(1500)
                .attrTween("d", arcTween);*/
        });
    };







    function mrdniGa() {
        //uzmi ceo i transliraj ga na ivicu
        d3.select("#container").attr("transform", "translate(" + (width + 20) + "," + (height / 2) + ")");

        //uzmi sve podatke i filtriraj ih, da odgovaraju samo jednoj kategoriji

    }

    function rotirajGa(argument) {
        //uzmi prethodnu vrednost
        //dodaj jos 10 stepeni

        //uzmi element na koji je kliknuto
        /*var prev = b.previousElementSibling
        var next = b.previousElementSibling*/

        d3.select("#rotiraj").style("transform", "rotateZ(10deg)")
    }

    function mouseover(d, j) {

        d3.select('#labelCenter p').html(d.name);

        /*scale*/
        var tempEl = d3.selectAll("path").filter(function(la, po) {
            return la.br == d.br && la.int_br_nabavke == d.int_br_nabavke;
        })

        //prvo vratiti sve, a onda izdici jedan
        //d3.selectAll("path").classed({"vracen":true,"izdvojen":false});
        tempEl.classed("izdvojen", true)
        tempEl.classed("vracen", false);

        var sequenceArray = getAncestors(d);
        updateBreadcrumbs(sequenceArray, "");

    }

    function stash(d) {
        d.x0 = d.x;
        d.dx0 = d.dx;
    }

    function arcTween(a) {
        var i = d3.interpolate({
            x: a.x0,
            dx: a.dx0
        }, a);
        return function(t) {
            var b = i(t);
            a.x0 = b.x;
            a.dx0 = b.dx;
            return arc(b);
        };
    }

    /*==================================
    =            Breadcrumb            =
    ==================================*/




    function mouseleaveCell(d, i) {

        var tempEl = d3.selectAll("path").filter(function(la, po) {
            return la.br == d.br && la.int_br_nabavke == d.int_br_nabavke;
        });
        tempEl.classed("izdvojen", false);
        tempEl.classed("vracen", true);
    }


    function mouseleave(d) {


        //hide tips
        d3.select(".tip").style("visibility", "hidden");

        // Hide the breadcrumb trail
        d3.select("#trail")
            .style("visibility", "hidden");

        // Deactivate all segments during transition.
        d3.selectAll("path").on("mouseover", null);

        // Transition each segment to full opacity and then reactivate it.
        d3.selectAll("path")
            .transition()
            .duration(300)
            .style("opacity", 1)
            .each("end", function() {
                d3.select(this).on("mouseover", mouseover);
            });

        d3.select("#explanation")
            .style("visibility", "hidden");
    }

    // Given a node in a partition layout, return an array of all of its ancestor
    // nodes, highest first, but excluding the root.
    function getAncestors(node) {
        var path = [];
        var current = node;
        while (current.parent) {
            path.unshift(current);
            current = current.parent;
        }
        return path;
    }

    function initializeBreadcrumbTrail() {
        // Add the svg area.
        var trail = d3.select("#sequence").append("svg:svg")
            .attr("width", width)
            .attr("height", 50)
            .attr("id", "trail");
        // Add the label at the end, for the percentage.
        trail.append("svg:text")
            .attr("id", "endlabel")
            .style("fill", "yellow");
    }

    // Generate a string that describes the points of a breadcrumb polygon.
    function breadcrumbPoints(d, i) {
        var points = [];
        points.push("0,0");
        points.push(b.w + ",0");
        points.push(b.w + b.t + "," + (b.h / 2));
        points.push(b.w + "," + b.h);
        points.push("0," + b.h);
        if (i > 0) { // Leftmost breadcrumb; don't include 6th vertex.
            points.push(b.t + "," + (b.h / 2));
        }
        return points.join(" ");
    }

    // Update the breadcrumb trail to show the current sequence and percentage.
    function updateBreadcrumbs(nodeArray, percentageString) {

        // Data join; key function combines name and depth (= position in sequence).
        var g = d3.select("#trail")
            .selectAll("g")
            .data(nodeArray, function(d) {
                return d.idNum;//d.name + d.depth;
            });

        // Add breadcrumb and label for entering nodes.
        var entering = g.enter().append("svg:g");

        entering.append("svg:polygon")
            .attr("points", breadcrumbPoints)
            .style("fill", function(d) {
                return d.color/*colors[Math.floor(Math.random() * 3)]*/;
            });

        entering.append("svg:text")
            .attr("x", (b.w + b.t) / 2)
            .attr("y", b.h / 2)
            .attr("dy", "0.35em")
            .attr('fill', "white" )
            .attr("text-anchor", "middle")
            .text(function(d) {
                return d.name;
            });

        // Set position for entering and updating nodes.
        g.attr("transform", function(d, i) {
            return "translate(" + i * (b.w + b.s) + ", 0)";
        });

        // Remove exiting nodes.
        g.exit().remove();

        // do not display last percentage on breadcrumb
        if (nodeArray.length > 2) {
            percentageString = "";
        }


        // Now move and update the percentage at the end.
       /* d3.select("#trail").select("#endlabel")
            .attr("x", (nodeArray.length + 0.5) * (b.w + b.s))
            .attr("y", b.h / 2)
            .attr("dy", "0.35em")
            .attr("text-anchor", "middle")
            .text(percentageString);*/


        // Make the breadcrumb trail visible, if it's hidden.
        d3.select("#trail")
            .style("visibility", "");

    }
    /*=====  End of Breadcrumb  ======*/
    </script>
</body>

</html>
