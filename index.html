<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic,800&subset=latin,cyrillic' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="https://cdn.rawgit.com/davidstutz/bootstrap-multiselect/master/dist/css/bootstrap-multiselect.css" type="text/css"/> -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="public/css/style.css">
	<link rel="stylesheet" href="//rawgithub.com/Caged/d3-tip/master/examples/example-styles.css">

    <script src="public/js/d3.v3.min.js"></script>
    <script src="public/js/underscore-min.js"></script>
    <script src="public/js/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="public/js/transformacija.js"></script>
    <script src="public/js/bcrumbs.js"></script>
    <script src="public/js/drugi.js"></script>
    <script src="public/js/settings.js"></script>
    <script src="public/js/tooltip.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.min.js"></script>	

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
    <!-- <script type="text/javascript" src="https://cdn.rawgit.com/davidstutz/bootstrap-multiselect/master/dist/js/bootstrap-multiselect.js"></script> -->

    <script>
    $(function () {
    	$( "#datum_od" ).datepicker({dateFormat: 'dd.mm.yy.'});
    	$( "#datum_do" ).datepicker({dateFormat: 'dd.mm.yy.'});


    })

    $(function() {
	    var sl = $( "#slider" ).slider({
	      range: true,
	      min: 5*1000*1000,
	      max: 5*1000*1000*1000,
	      //values: [  50, 100 ],
	      slide: function( event, ui ) {
	      	$("#iznos_od").val( ui.values[ 0 ])
	      	$("#iznos_do").val( ui.values[ 1 ])
	        
	      }
	    });

	    sl.slider( "option", "values", [ 100000000, 2500000000 ] );


	    $("#iznos_od").val($( "#slider" ).slider( "values", 0 ))
	      	$("#iznos_do").val( $( "#slider" ).slider( "values", 1 ))


  });

    $(function () {
    	  	 $( "#sliderPonuda" ).slider({
	      range: true,
	      min: 0,
	      max: 10,
	      values: [ 2, 6 ],
	      slide: function( event, ui ) {
	      	$( "#amount_label" ).html( 
	    	  ui.values[ 0 ] + " - "   	 +  ui.values[ 1 ]    	 );
	      	
	      }
	    });
	        
	    $( "#amount_label" ).html( 
	    	 $( "#sliderPonuda" ).slider( "values", 0 ) + " - " 
	    	 + $( "#sliderPonuda" ).slider( "values", 1 ) 
    	 );
    })
    </script>
</head>

<body>
	<header class="container-fluid no-gutter">
		<div class="base row">
			<div class="logo col-md-2 col-md-offset-2 col-xs-offset-none col-xs-3"></div>
			<div class="col-md-4 col-xs-6">
				<h3 >Javne nabavke Ministarstava</h3>
				<h4 >Unutrašnjih poslova i Odbrane</h4>
			</div>
			<div class="col-md-3">
				<img src="./public/img/bedge-1.png" alt=""><img src="./public/img/bedge-2.png" alt="">
			</div>
		</div>
		
	</header>

	<input type="radio" name="izbor" id="" value="iznos">Iznosi
    <input type="radio" name="izbor" id="" value="broj">Brojčano



    <div class="container-fluid">
        <div class="col-md-2">
            <form>
                <!-- Left -->
                
                <div id="selektori" class="">
                	<div class="krajnji-border gray-background">Detaljna pretraga</div>
                	<div class="krajnji-border">
                		<input type="checkbox" name="narucilac[]" value="mup"><span>Mup</span>
	                    <br>
	                    <input type="checkbox" name="narucilac[]" value="mo"><span>Ministarstvo odbrane</span>
                    </div>
                	
					<div class="srednji-border">
						<input type="checkbox" name="predmet[]" value="dobra"><span>Dobra</span>
						<br>
						<input type="checkbox" name="predmet[]" value="usluge"><span>Usluge</span>
						<br>
						<input type="checkbox" name="predmet[]" value="usluge"><span>Radovi</span>
					</div>
					
                   
                   <div class="srednji-border">
                   	 <select name="maticniBroj" id="maticniBroj">
                   	    <option value="" selected disabled>Matični broj</option>
                   	    <option value="07093608">07093608</option>
                   	    <option value="07008104">07008104</option>
                   	</select>
                   </div>
                    

                    <div class="srednji-border">
                    	<select name="postupak" id="postupak">
                    	    <option value="" selected disabled>Tip postupka</option>
                    	    <option value="otvoreni">Otvoreni postupak</option>
                    	    <option value="restriktivni">Restriktivni postupak</option>
                    	    <option value="sa_objavljivanjem">Bez objavljivanja</option>
                    	    <option value="bez_objavljivanja">Sa objavljivanjem</option>
                    	    <option value="kvalifikacioni">Konkurs za dizajn</option>
                    	    <option value="kvalifikacioni">Postupak javne nabavke male vrednosti</option>
                    	    <option value="kvalifikacioni">Kvalifikacioni postupak</option>
                    	    <option value="kvalifikacioni">Konkurentni dijalog</option>
                    	</select>
                    </div>
                    <div class="srednji-border">
                    	<select name="predmet" id="predmet">
                    	    <option value="" selected disabled>Predmet</option>
                    	    <option value="dobra">Dobra</option>
                    	    <option value="usluge">Usluge</option>
                    	    <option value="radovi">Radovi</option>
                    	</select>
                    </div>
                    
                    
                    
                    <div class="srednji-border"> 
                    <span>Ugovorena cena:</span>
                    <br>
                    	<span>
                        	<input type="text" lang="en" name="iznos_od" id="iznos_od" class="input-sm col-md-5"></span>
						<span>
							<input type="text" lang="en" name="iznos_do" id="iznos_do" class="input-sm col-md-5 col-md-offset-1"></span>	
							<br>
							<br>
							
                        <div name="cena_pdv" id="slider"></div>
                        <br>
                        
                    </div>
                    <div class="srednji-border">
                    	
                        <input type="text" name="datum_od" id="datum_od" placeholder="datum od" class="input-sm col-md-5">
                        <input type="text" name="datum_do" id="datum_do" placeholder="datum do" class="input-sm col-md-5 col-md-offset-1">
                        <br>
                        <br>
                    </div>
					

                    <div class="krajnji-border">

                    	<span>Broj ponuda:</span>
                    	
						<span id="amount_label"></span>
                    	<div name="ponuda" id="sliderPonuda"></div>

                    </div>
                    <div class="margin-20px krajnji-border invert button-search">
                        Pretraži    >
                    </div>
                    <!-- Right -->
                </div>
            </form>
        </div>
        <div class="col-md-8">
            <div class="tip"></div>
            <div id="sequence"></div>
            <div id="wrap" class="row">
                <div id="chart" class="col-md-8"></div>
                <div id="chart2" class="col-md-4"></div>
            </div>
        </div>
    </div>
    <script>
    //http://bl.ocks.org/mbostock/4063423

    var tip = d3.tip().attr('class', 'd3-tip').html(function(d) { return d.name ; });

	

    // Dimensions of sunburst.
    var width = 750;
    var height = 600;
    var radius = Math.min(width, height) / 2;

    // Breadcrumb dimensions: width, height, spacing, width of tip/tail.
    var b = {
        w: 220,
        h: 30,
        s: 3,
        t: 10
    };

    // Mapping of step names to colors.

    var colors = {
        "radovi": {
            "osnovna": "#1b9e77",
            "izvedene": {
                "restriktivni": "#093427",
                "otvoreni": "#157A5C",
                "sa_objavljivanjem": "#23D19D",
                "bez_objavljivanja": "#62E4BD",
                "kvalifikacioni": "#CBF6E9"
            }
        },
        "dobra": {
            "osnovna": "#d95f02",
            "izvedene": {
                "restriktivni": "#3D1B01",
                "otvoreni": "#A24702",
                "sa_objavljivanjem": "#FD8021",
                "bez_objavljivanja": "#FD9749",
                "kvalifikacioni": "#FED1AE"
            }
        },
        "usluge": {
            "osnovna": "#7570b3",
            "izvedene": {
                "restriktivni": "#1E1C35",
                "otvoreni": "#433F78",
                "sa_objavljivanjem": "#5A54A0",
                "bez_objavljivanja": "#A4A1CE",
                "kvalifikacioni": "#D8D7EA"
            }
        }
    }


    var HTMLabsoluteTip = d3.select("div.tip");

    var mera = radius * 0.5;

    // Total size of all segments; we set this later, after loading the data.
    var totalSize = 0;
    var pomeraj = -mera / 2;

    var vis = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("svg:g")
        .attr("id", "container")
        .attr("transform", "translate(" + width / 3 + "," + height / 2 + ")")
        .append("g")
        .attr("id", "rotiraj");

   


    var label = vis.append("g");
    label.append('foreignObject')
        .attr('width', mera)
        .attr('height', mera)
        .attr("transform", "translate(" + pomeraj + "," + pomeraj + ")")
        .append("xhtml:div")
        .attr('id', "labelCenter")
        .append("xhtml:p");




    //change dinaicly size of circle
    var partition = d3.layout.partition()
        .sort(null)
        .size([2 * Math.PI, radius * radius * 0.5])
        .value(function(d) {
            return d.cena_pdv;
        });

    var arc = d3.svg.arc()
        .startAngle(function(d) {
            return d.x;
        })
        .endAngle(function(d) {
            return d.x + d.dx;
        })
        .innerRadius(function(d) {
            return Math.sqrt(d.y);
        })
        .outerRadius(function(d) {
            return Math.sqrt(d.y + d.dy);
        });

    //initializeBreadcrumbTrail();



    // Setup for switching data: stash the old values for transition.
    function stash(d) {
        d.x0 = d.x;
        d.dx0 = d.dx;
    }

    function arcTweenData(a, i) {
        var oi = d3.interpolate({
            x: a.x0,
            dx: a.dx0
        }, a);

        function tween(t) {
            var b = oi(t);
            a.x0 = b.x;
            a.dx0 = b.dx;
            return arc(b);
        }
        if (i == 0) {
            // If we are on the first arc, adjust the x domain to match the root node
            // at the current zoom level. (We only need to do this once.)
            var xd = d3.interpolate(x.domain(), [node.x, node.x + node.dx]);
            return function(t) {
                x.domain(xd(t));
                return tween(t);
            };
        } else {
            return tween;
        }
    }

    function arcTweenZoom(d) {
        var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
            yd = d3.interpolate(y.domain(), [d.y, 1]),
            yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
        return function(d, i) {
            return i ? function(t) {
                return arc(d);
            } : function(t) {
                x.domain(xd(t));
                y.domain(yd(t)).range(yr(t));
                return arc(d);
            };
        };
    }

    d3.csv('rawData/uzorak2.csv', function(err, data) {

        var json = transformData(data);

        createVisualization(json);
     
    })


    /*======================================
    =            filterPretraga            =
    ======================================*/

    function filterPretraga(nizArgumenata) {


        var tempEl = d3.selectAll("path").filter(function(la, po) {
            var uslov = true;
            
            if (la.children != undefined) return false;

            for (var i = 0, len = nizArgumenata.length; i < len; i++) {

                if (la["postupak"] == undefined) return false;

                if (nizArgumenata[i].name == "postupak")
                    uslov &= (la["postupak"].toLowerCase().indexOf(nizArgumenata[i].value.replace("_", " ")) != -1 );
                else if (nizArgumenata[i].name == "predmet")
                    uslov &= (la["predmet"].toLowerCase().indexOf(nizArgumenata[i].value) != -1);
                else if (nizArgumenata[i].name == "ponuda")
                    uslov &= (+la["broj_ponuda"] == +nizArgumenata[i].value);
                else if (nizArgumenata[i].name == "iznos_od")
                    uslov &= (+la["cena_pdv"] >= +nizArgumenata[i].value );
                
                else if (nizArgumenata[i].name == "iznos_do")
                    uslov &= (+la["cena_pdv"] <= +nizArgumenata[i].value );
                
                else if(nizArgumenata[i].name == "narucilac"){
                	uslov &= la["narucilac"].toLowerCase() == nizArgumenata[i].value.toLowerCase();
                }
                else if(nizArgumenata[i].name == "maticniBroj"){
                	uslov &=  ( nizArgumenata[i].value.trim() .indexOf(la["maticni_broj"] ) !=-1 );
                }
                else if(nizArgumenata[i].name == "datum_od" && nizArgumenata[i].value.length > 0){
                	uslov &=  moment( la["datum"].trim(),"DD.MM.YYYY." ).isAfter( moment(nizArgumenata[i].value,"DD.MM.YYYY."))  ;
                }
                else if(nizArgumenata[i].name == "datum_do" && nizArgumenata[i].value.length > 0 ){
                	uslov &=  moment( la["datum"].trim(), "DD.MM.YYYY." ).isBefore( moment(nizArgumenata[i].value,"DD.MM.YYYY."))  ;
                }

                //postupak predmet, ponuda , cena 
            }

            return uslov ;
        })

        return tempEl
    }

    d3.select("button").on("click", function() {
        var parametri = $("form").serializeArray();
        var res = filterPretraga(parametri)
        res.style("fill", "red");

        if (res.data().length == 0)
            alert("Nema podataka za zadate kriterijume");
        else
            secondGraph(res.data())
            //napraviti poseban graf ovde
    })




    function createVisualization(json) {



        // Bounding circle underneath the sunburst, to make it easier to detect
        // when the mouse leaves the parent g.
        vis.append("svg:circle")
            .attr("r", radius)
            .style("opacity", 0);

        var tooltip = d3.select('#chart')                               
          .append('div')                                                
          .attr('class', 'MyTooltip');                                    
                      
        tooltip.append('div')                                           
          .attr('class', 'label');                                      
             
        tooltip.append('div')                                           
          .attr('class', 'count');                                      

        tooltip.append('div')                                           
          .attr('class', 'percent');     

        var path = vis.datum(json).selectAll("path")
            .data(partition.nodes(json))
            .enter().append("svg:path")
            .attr("display", function(d) {
                return d.depth ? null : "none";
            })
            .attr("d", arc)
            .attr("fill-rule", "evenodd")
            .style("stroke", "#fff")
            .style("fill", function(d) {
                return d.color;
            })
            .style("opacity", 1)
            .on("mouseover", function(d, j) {
                //if(d.depth!=0 && d.depth == 2 && d.children ==undefined)
                mouseover(d, j);

                labelMouse(d, j);


            tooltip.select('.label').html("d.data.label");                
            tooltip.select('.count').html("d.data.count");                
            tooltip.select('.percent').html("54" + '%'); 
             tooltip.style('display', 'block');  

            })
            .on("mouseout",function (d, j) {
            	 //tooltip.style('display', 'none');  
            })
            .on('mousemove', function(d) {         
            	tooltip.style('top', (d3.event.offsetY -50 ) + 'px')          
              .style('left', (d3.event.offsetX -50 ) + 'px');       
          	})

            //.on("mouseleave", mouseleaveCell)
            .on("click", function (d,j) {
            	/*dodajTT(d,j, d3.mouse(this));
            	staviSadrzajTT(d, j , d3.mouse(this))*/

            })
            .each(stash);



        // Basic setup of page elements.
        initializeBreadcrumbTrail();

        d3.selectAll("input[name='izbor']").on("change", function change() {
            var value = this.value === "broj" ? function() {
                return 1;
            } : function(d) {
                return d.cena_pdv;
            };

            path
                .data(partition.value(value).nodes)
                .transition()
                .duration(1500)
                .attrTween("d", arcTween);
        });

        // Add the mouseleave handler to the bounding circle.
        d3.select("#container").on("mouseleave", mouseleave);

        // Get total size of the tree = value of root node from partition.
        totalSize = path.node().__data__.value;

    };


    function labelMouse(d, j) {
        d3.select('#labelCenter p').html(d.name);
    }

    function mouseover(d, j) {

        /*scale*/
        var tempEl = d3.selectAll("path").filter(function(la, po) {
            return la.br == d.br && la.int_br_nabavke == d.int_br_nabavke;
        })

        var sequenceArray = getAncestors(d);
        updateBreadcrumbs(sequenceArray, "");

    }

    function mouseleave(d) {

        //hide tips
        d3.select(".tip").style("visibility", "hidden");

        // Hide the breadcrumb trail
        d3.select("#trail")
            .style("visibility", "hidden");

        // Deactivate all segments during transition.
        d3.selectAll("path").on("mouseover", null);

        // Transition each segment to full opacity and then reactivate it.
        d3.selectAll("path")
            .transition()
            .duration(300)
            .style("opacity", 1)
            .each("end", function() {
                d3.select(this).on("mouseover", mouseover);
            });

        d3.select("#explanation")
            .style("visibility", "hidden");
    }

    function stash(d) {
        d.x0 = d.x;
        d.dx0 = d.dx;
    }

    function arcTween(a) {

        var i = d3.interpolate({
            x: a.x0,
            dx: a.dx0
        }, a);

        return function(t) {
            var b = i(t);
            a.x0 = b.x;
            a.dx0 = b.dx;
            return arc(b);
        };
    }
    </script>
</body>

</html>
