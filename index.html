<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="public/js/d3.v3.min.js"></script>
    <script src="public/js/underscore-min.js"></script>
    <script src="public/js/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
	<script src="public/js/transformacija.js"></script>
	<script src="public/js/drugi.js"></script>
	<script src="public/js/bcrumbs.js"></script>

    <style>
    #chart2 {
        overflow-y: scroll;
        width: 400px;
    }
    
    #chart2 svg {
        height: 100vh;
    }
    
    .izdvojen {
        transform: scale(1.10);
    }
    
    .vracen {
        transform: scale(1);
    }
    
    .bar.positive {
        fill: steelblue;
    }
    
    .bar.negative {
        fill: brown;
    }
    </style>
</head>

<body>

	<input type="radio" name="izbor" id="" value="iznos">Iznosi
	<input type="radio" name="izbor" id="" value="broj">Brojƒçano
    
    <form>
        <select name="postupak" id="">
            <option value="otvoreni">Otvoreni</option>
            <option value="restriktivni">Restriktivni</option>
            <option value="sa_objavljivanjem">Sa objavljivanjem</option>
            <option value="bez_objavljivanja">Bez objavljivanja</option>
            <option value="kvalifikacioni">Kvalifikacioni</option>
        </select>
        <select name="predmet" id="">
            <option value="dobra">Dobra</option>
            <option value="usluge">Usluge</option>
            <option value="radovi">Radovi</option>
        </select>
        <select name="ponuda" id="">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
        </select>
        <input type="number" name="cena">
        <button type="button">Trazi</button>
    </form>
    <div class="tip"></div>
    <div id="sequence"></div>
    <div id="wrap" class="row">
        <div id="chart" class="col-md-8"></div>
        <div id="chart2" class="col-md-4"></div>
    </div>
    <script>
    //http://bl.ocks.org/mbostock/4063423



    // Dimensions of sunburst.
    var width = 750;
    var height = 600;
    var radius = Math.min(width, height) / 2;

    // Breadcrumb dimensions: width, height, spacing, width of tip/tail.
    var b = {
        w: 220,
        h: 30,
        s: 3,
        t: 10
    };

    // Mapping of step names to colors.
   
    var colors = 
    {
	  "radovi":{
	    "osnovna": "#1b9e77",
	    "izvedene": {
	      "restriktivni": "#093427",
	      "otvoreni": "#157A5C",
	      "sa_objavljivanjem": "#23D19D",
	      "bez_objavljivanja": "#62E4BD",
	      "kvalifikacioni": "#CBF6E9"
	    }
	  },
	  "dobra": {	    
	    "osnovna": "#d95f02",
	    "izvedene": {
	      "restriktivni": "#3D1B01",
	      "otvoreni": "#A24702",
	      "sa_objavljivanjem": "#FD8021",
	      "bez_objavljivanja": "#FD9749",
	      "kvalifikacioni": "#FED1AE"
	    }
	  },
	  "usluge":{	    
	    "osnovna": "#7570b3",
	    "izvedene": {
	      "restriktivni": "#1E1C35",
	      "otvoreni": "#433F78",
	      "sa_objavljivanjem": "#5A54A0",
	      "bez_objavljivanja": "#A4A1CE",
	      "kvalifikacioni": "#D8D7EA"
	    }
	  }
	}


    var HTMLabsoluteTip = d3.select("div.tip");

    var mera = radius * 0.5;

    // Total size of all segments; we set this later, after loading the data.
    var totalSize = 0;
    var pomeraj = -mera / 2;

    var vis = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("svg:g")
        .attr("id", "container")
        .attr("transform", "translate(" + width / 3 + "," + height / 2 + ")")
        .append("g")
        .attr("id", "rotiraj");



    var label = vis.append("g");
    label.append('foreignObject')
        .attr('width', mera)
        .attr('height', mera)
        .attr("transform", "translate(" + pomeraj + "," + pomeraj + ")")
	.append("xhtml:div")    	
        .attr('id', "labelCenter")
        .append("xhtml:p");
        

    

    //change dinaicly size of circle
    var partition = d3.layout.partition()
        .sort(null)
        .size([2 * Math.PI, radius * radius * 0.5])
        .value(function(d) {
            return d.cena_pdv;
        });

    var arc = d3.svg.arc()
        .startAngle(function(d) {
            return d.x;
        })
        .endAngle(function(d) {
            return d.x + d.dx;
        })
        .innerRadius(function(d) {
            return Math.sqrt(d.y);
        })
        .outerRadius(function(d) {
            return Math.sqrt(d.y + d.dy);
        });



     

	// Setup for switching data: stash the old values for transition.
	function stash(d) {
	  d.x0 = d.x;
	  d.dx0 = d.dx;
	}  	

  	function arcTweenData(a, i) {
	  var oi = d3.interpolate({x: a.x0, dx: a.dx0}, a);
	  function tween(t) {
	    var b = oi(t);
	    a.x0 = b.x;
	    a.dx0 = b.dx;
	    return arc(b);
	  }
	  if (i == 0) {
	   // If we are on the first arc, adjust the x domain to match the root node
	   // at the current zoom level. (We only need to do this once.)
	    var xd = d3.interpolate(x.domain(), [node.x, node.x + node.dx]);
	    return function(t) {
	      x.domain(xd(t));
	      return tween(t);
	    };
	  } else {
	    return tween;
	  }
	}    

	function arcTweenZoom(d) {
	  var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
	      yd = d3.interpolate(y.domain(), [d.y, 1]),
	      yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
	  return function(d, i) {
	    return i
	        ? function(t) { return arc(d); }
	        : function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); return arc(d); };
	  };
	}

    d3.csv('rawData/uzorak.csv', function(err, data) {


        var json = transformData(data);

        createVisualization(json);
    })


    



    /*======================================
    =            filterPretraga            =
    ======================================*/

    function filterPretraga(nizArgumenata) {


        var tempEl = d3.selectAll("path").filter(function(la, po) {
            var uslov = true;
            if (la.children != undefined) return false;
            for (var i = 0, len = nizArgumenata.length; i < len; i++) {

            	if(la["postupak"] == undefined) return false;

                if (nizArgumenata[i].name == "postupak")
                    uslov &= la["postupak"].toLowerCase().indexOf(nizArgumenata[i].value.replace("_", " ")) != -1;
                else if (nizArgumenata[i].name == "predmet")
                    uslov &= la["predmet"].toLowerCase().indexOf(nizArgumenata[i].value) != -1;
                else if (nizArgumenata[i].name == "ponuda")
                    uslov &= +la["broj_ponuda"] == +nizArgumenata[i].value;
                else if (nizArgumenata[i].name == "cena_pdv")
                    uslov &= +la["cena_pdv"] >= +nizArgumenata[i].value;

                //postupak predmet, ponuda , cena 
            }

            return uslov;
        })

        return tempEl
    }

    d3.select("button").on("click", function() {
        var parametri = $("form").serializeArray();
        var res = filterPretraga(parametri)
        res.style("fill", "red");

        if(res.data().length == 0)
        	alert("Nema podataka za zadate kriterijume");
        else
        	secondGraph(res.data())
            //napraviti poseban graf ovde
    })




    function createVisualization(json) {


        // Basic setup of page elements.
        initializeBreadcrumbTrail();

        // Bounding circle underneath the sunburst, to make it easier to detect
        // when the mouse leaves the parent g.
        vis.append("svg:circle")
            .attr("r", radius)
            .style("opacity", 0);

       /* // For efficiency, filter nodes to keep only those large enough to see.
        var nodes = partition.nodes(json)
            .filter(function(d) {
                return (d.dx > 0.005); // 0.005 radians = 0.29 degrees
            });*/

        var path = vis.datum(json).selectAll("path")
            .data(partition.nodes(json))
            .enter().append("svg:path")
            .attr("display", function(d) {
                return d.depth ? null : "none";
            })
            .attr("d", arc)
            .attr("fill-rule", "evenodd")
            .style("stroke", "#fff")
            .style("fill", function(d) {
            	return  d.color;
            })
            .style("opacity", 1)
            .on("mouseover", function (d, j) {
            	//if(d.depth!=0 && d.depth == 2 && d.children ==undefined)
            		//mouseover(d, j);

            	labelMouse(d,j);
            })
            //.on("mouseleave", mouseleaveCell)
            //.on("click", mrdniGa)
            .each(stash);

        d3.selectAll("input[name='izbor']").on("change", function change() {
		    var value = this.value === "broj"
		        ? function() { return 1; }
		        : function(d) { return d.cena_pdv; };

		    path
		        .data(partition.value(value).nodes)
		      .transition()
		        .duration(1500)
		        .attrTween("d", arcTween);
		  });

        // Add the mouseleave handler to the bounding circle.
        d3.select("#container").on("mouseleave", mouseleave);

        // Get total size of the tree = value of root node from partition.
        totalSize = path.node().__data__.value;
        
    };


    function labelMouse (d,j) {
    	d3.select('#labelCenter p').html(d.name);
    }

    function mouseover(d, j) {

        /*scale*/
        var tempEl = d3.selectAll("path").filter(function(la, po) {
            return la.br == d.br && la.int_br_nabavke == d.int_br_nabavke;
        })

        var sequenceArray = getAncestors(d);
        updateBreadcrumbs(sequenceArray, "");

    }

     function mouseleave(d) {

        //hide tips
        d3.select(".tip").style("visibility", "hidden");

        // Hide the breadcrumb trail
        d3.select("#trail")
            .style("visibility", "hidden");

        // Deactivate all segments during transition.
        d3.selectAll("path").on("mouseover", null);

        // Transition each segment to full opacity and then reactivate it.
        d3.selectAll("path")
            .transition()
            .duration(300)
            .style("opacity", 1)
            .each("end", function() {
                d3.select(this).on("mouseover", mouseover);
            });

        d3.select("#explanation")
            .style("visibility", "hidden");
    }

    function stash(d) {
        d.x0 = d.x;
        d.dx0 = d.dx;
    }

    function arcTween(a) {
        
        var i = d3.interpolate({
            x: a.x0,
            dx: a.dx0
        }, a);

        return function(t) {
            var b = i(t);
            a.x0 = b.x;
            a.dx0 = b.dx;
            return arc(b);
        };
    }


    </script>
    
</body>

</html>
